angular.module('app', [
  'ui.router',
  'ngAnimate', 
  'appRoutes', 
  'app.factories', 
  'MainCtrl', 
  'HomeCtrl', 
  'DashboardCtrl', 
  'PortfolioCtrl',
  'PortfolioDetailCtrl'
]);
angular.module('appRoutes', []).config(['$stateProvider', '$locationProvider', '$urlRouterProvider', function($stateProvider, $locationProvider, $urlRouterProvider) {

    $urlRouterProvider.otherwise("/");

    $stateProvider

        .state('home', {
            url: '/',
            views: {
                header: {
                    templateUrl: '/templates/_common/templates/header.tmpl.html',
                },
                content: {
                    templateUrl: '/templates/home/home.view.html',
                    controller: 'HomeController',
                    controllerAs: 'home'
                },
                footer: {
                    templateUrl: '/templates/_common/templates/footer.tmpl.html',
                }
            }
        })

        .state('dashboard', {
            url: '/dashboard',
            views: {
                header: {
                    templateUrl: '/templates/_common/templates/header.tmpl.html',
                },
                content: {
                    templateUrl: '/templates/dashboard/dashboard.view.html',
                    controller: 'DashboardController',
                    controllerAs: 'dashboard'
                },
                footer: {
                    templateUrl: '/templates/_common/templates/footer.tmpl.html',
                }
            }
        })

        .state('portfolio', {
            url: '/portfolio',
            views: {
                header: {
                    templateUrl: '/templates/_common/templates/header.tmpl.html',
                },
                content: {
                    templateUrl: '/templates/portfolio/portfolio.view.html',
                },
                footer: {
                    templateUrl: '/templates/_common/templates/footer.tmpl.html',
                }
            },
            redirectTo: 'portfolio.index'
        })

            .state('portfolio.index', {
                url: '',
                views: {
                    portfolio: {
                        templateUrl: '/templates/portfolio/index/index.view.html',
                        controller: 'PortfolioController',
                        controllerAs: 'portfolio'
                    }
                }
            })

            .state('portfolio.detail', {
                url: '/:portfolioBase/:portfolioTitle',
                views: {
                    portfolio: {
                        templateUrl: '/templates/portfolio/detail/detail.view.html',
                        controller: 'PortfolioDetailController',
                        controllerAs: 'detail',
                        resolve: {
                            portfolioBase: ['$stateParams', '$state', function($stateParams, $state){
                                if(!$stateParams.portfolioBase) {
                                    $state.go('portfolio');
                                }  else {
                                    return $stateParams.portfolioBase;
                                }                               
                            }],
                            portfolioTitle: ['$stateParams', '$state', function($stateParams, $state){
                                if(!$stateParams.portfolioTitle) {
                                    $state.go('portfolio');
                                }  else {
                                    return $stateParams.portfolioTitle;
                                }                               
                            }]
                        }
                    }
                }
            })

        .state('login', {
            url: '/login',
            external: true
        })

        .state('logout', {
            url: '/logout',
            external: true
        })

        .state('register', {
            url: '/register',
            external: true
        })

        ;

    $locationProvider.html5Mode({
        enabled: true,
        requireBase: false
    });

}]);
angular.module('DashboardCtrl', []).controller('DashboardController', function(Page) {
  var vm = this;

  Page.setTitle('Dashboard');   
  vm.title = 'Dashboard';

});
angular.module('HomeCtrl', []).controller('HomeController', function(Page) {
  var vm = this;

  Page.setTitle('Home');   
  vm.title = 'Home';
});
angular.module('PortfolioCtrl', []).controller('PortfolioController', function($http, Page, $location) {
  var vm = this;

  Page.setTitle('Portfolio');  
  vm.title = 'Portfolio';

  $http.get('/api/portfolio')
    .success(function (res) {
      vm.list = res;
    });
});

(function() {
  'use strict';

  angular
    .module('app.factories', ['ngResource'])
    ;
})();

(function() {
  'use strict';

  angular
    .module('app.factories')
    .factory('NavigationResource', navigationResource)
  ;

  /* @ngInject */
  function navigationResource($resource) {
    var uri = '/api/navigation/';
    var timeout = 1000;
    console.log('return navigation api');
    //return $resource(uri, {ps: 'display'});
  }
})();

(function() {
  'use strict';

  angular
    .module('app.factories')
    .factory('Page', page)
  ;

  /* @ngInject */
  function page() {
    var title = 'Boilerplate';
    return {
      title: function() { return title + ' | Boilerplate'; },
      setTitle: function(newTitle) { title = newTitle + ' | Boilerplate' }
    };
  }
})();
angular.module('MainCtrl', []).controller('MainController', function($state, $rootScope, $http, $window, Page) {
  var vm = this;

  vm.Page = Page;
  
  $http.get('/api/navigation')
    .success(function (res) {
      vm.navigation = res
    });

  $http.get('/auth/user')
    .success(function (res) {
      vm.user = res;
    })
    .error(function (res) {
      console.log('not logged in');
    });

  vm.state = $state;

  vm.date = new Date();

  $rootScope.$on('$stateChangeStart', function(evt, to, params) {
    if (to.redirectTo) {
      evt.preventDefault();
      $state.go(to.redirectTo, params)
    } else if (to.external) {
      evt.preventDefault();
      $window.open(to.url, '_self');
    }
  });
});
angular.module('PortfolioDetailCtrl', []).controller('PortfolioDetailController', function($http, Page, portfolioBase, portfolioTitle) {
  var vm = this;
  
  $http.get('/api/portfolio/' + portfolioBase + '/' + portfolioTitle)
    .success(function (res) {
      vm.portfolioDetail = res;
    });
  $http.get('/api/portfolio/preview/' + portfolioBase + '/' + portfolioTitle)
    .success(function (res) {
      vm.portfolioPreview = res;
      Page.setTitle(res.project);
    });
});
